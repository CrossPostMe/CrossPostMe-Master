name: Deploy Frontend to Hostinger (SSH)

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: CrossEnv
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Node (for completeness)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build frontend
        run: |
          set -euo pipefail
          corepack enable || true
          corepack prepare yarn@1.22.22 --activate || true
          yarn --cwd app/frontend install --frozen-lockfile || yarn --cwd app/frontend install
          yarn --cwd app/frontend build

      - name: Deploy build to Hostinger (SSH)
        env:
          SSH_PRIVATE_KEY: ${{ secrets.HOSTINGER_SSH_KEY }}
          HOST: ${{ secrets.HOSTINGER_SSH_HOST }}
          USER: ${{ secrets.HOSTINGER_SSH_USER }}
          PORT: ${{ secrets.HOSTINGER_SSH_PORT }}
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H "$HOST" >> ~/.ssh/known_hosts

          # package build into a tar in runner temp and upload
          TAR_PATH="$RUNNER_TEMP/frontend_build.tar.gz"
          tar -C app/frontend -czf "$TAR_PATH" build

          # stream tar over ssh (avoids scp/sftp differences on some hosts)
          UPLOAD_LOG="$RUNNER_TEMP/upload_log.txt"
          if [ -n "${PORT:-}" ]; then
            set +e
            tar -C app/frontend -czf - build | ssh -v -i ~/.ssh/id_ed25519 -p "${PORT}" ${USER}@${HOST} "cat > /tmp/frontend_build.tar.gz" > "$UPLOAD_LOG" 2>&1
            UPLOAD_EXIT=$?
            set -e
          else
            set +e
            tar -C app/frontend -czf - build | ssh -v -i ~/.ssh/id_ed25519 ${USER}@${HOST} "cat > /tmp/frontend_build.tar.gz" > "$UPLOAD_LOG" 2>&1
            UPLOAD_EXIT=$?
            set -e
          fi

          if [ "$UPLOAD_EXIT" -ne 0 ]; then
            echo "upload via tar|ssh failed with exit $UPLOAD_EXIT; upload log follows:";
            sed -n '1,200p' "$UPLOAD_LOG" || true;
            exit $UPLOAD_EXIT
          fi

          if [ -n "${PORT:-}" ]; then
            ssh -v -i ~/.ssh/id_ed25519 -p "${PORT}" ${USER}@${HOST} "mkdir -p /home/${USER}/domains/crosspostme.com/public_html && tar -C /home/${USER}/domains/crosspostme.com/public_html -xzf /tmp/frontend_build.tar.gz && rm -f /tmp/frontend_build.tar.gz" 2>&1
          else
            ssh -v -i ~/.ssh/id_ed25519 ${USER}@${HOST} "mkdir -p /home/${USER}/domains/crosspostme.com/public_html && tar -C /home/${USER}/domains/crosspostme.com/public_html -xzf /tmp/frontend_build.tar.gz && rm -f /tmp/frontend_build.tar.gz" 2>&1
          fi

          rm -f "$TAR_PATH" || true

          if [ -n "${PORT:-}" ]; then
            ssh -i ~/.ssh/id_ed25519 -p "${PORT}" ${USER}@${HOST} "ls -la /home/${USER}/domains/crosspostme.com/public_html | head -n 40"
          else
            ssh -i ~/.ssh/id_ed25519 ${USER}@${HOST} "ls -la /home/${USER}/domains/crosspostme.com/public_html | head -n 40"
          fi
